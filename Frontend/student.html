<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SMC Sports Selection</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: Arial, sans-serif;
                display: flex;
                height: 100vh;
                background: #f5f5f5;
            }

            .sidebar {
                width: 250px;
                background: #2c3e50;
                color: white;
                padding: 20px 0;
                overflow-y: auto;
                box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            }

            .sidebar h2 {
                padding: 15px 20px;
                font-size: 18px;
                border-bottom: 2px solid #34495e;
                margin-bottom: 10px;
            }

            .sidebar-item {
                padding: 12px 20px;
                cursor: pointer;
                transition: all 0.3s;
                border-left: 3px solid transparent;
            }

            .sidebar-item:hover {
                background: #34495e;
                border-left-color: #3498db;
            }

            .sidebar-item.active {
                background: #3498db;
                border-left-color: #2980b9;
            }

            .content {
                flex: 1;
                overflow-y: auto;
                padding: 30px;
                padding-bottom: 100px;
            }

            .section {
                display: none;
                background: white;
                padding: 25px;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .section.active {
                display: block;
            }

            h1 {
                color: #2c3e50;
                margin-bottom: 20px;
                font-size: 28px;
            }

            h2 {
                color: #2c3e50;
                margin-bottom: 15px;
                font-size: 22px;
                border-bottom: 2px solid #ecf0f1;
                padding-bottom: 10px;
            }

            label {
                display: block;
                margin-top: 15px;
                margin-bottom: 8px;
                color: #2c3e50;
                font-weight: bold;
            }

            input, select, textarea {
                width: 100%;
                padding: 10px;
                margin-bottom: 15px;
                border: 1px solid #bdc3c7;
                border-radius: 4px;
                font-size: 14px;
                font-family: Arial, sans-serif;
                box-sizing: border-box;
            }

            input:focus, select:focus, textarea:focus {
                outline: none;
                border-color: #667eea;
            }

            button {
                padding: 10px 15px;
                margin: 8px 8px 8px 0;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
            }

            button:hover {
                opacity: 0.9;
                transform: translateY(-1px);
            }

            .btn-primary {
                background: #667eea;
                color: white;
            }

            .btn-secondary {
                background: #95a5a6;
                color: white;
            }

            .btn-success {
                background: #27ae60;
                color: white;
            }

            .message {
                padding: 10px;
                margin: 10px 0;
                border-radius: 4px;
                display: none;
            }

            .message.show {
                display: block;
            }

            .message.success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .message.error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }

            .closed-message {
                text-align: center;
                color: #c0392b;
            }

            .closed-message h2 {
                color: #c0392b;
            }

            .sport-card {
                background: #ecf0f1;
                padding: 15px;
                margin: 10px 0;
                border-radius: 4px;
                border-left: 4px solid #667eea;
            }

            .sport-name {
                font-weight: bold;
                color: #2c3e50;
                margin-bottom: 5px;
            }

            .sport-description {
                font-size: 13px;
                color: #555;
                margin-bottom: 10px;
                font-style: italic;
            }

            .sport-availability {
                font-size: 13px;
                color: #27ae60;
            }

            .sport-full {
                color: #c0392b;
            }

            .footer {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: #2c3e50;
                color: white;
                padding: 12px 20px;
                text-align: center;
                font-size: 12px;
                border-top: 1px solid #34495e;
            }

            @media (max-width: 768px) {
                body {
                    flex-direction: column;
                }

                .sidebar {
                    width: 100%;
                    height: auto;
                }
            }
        </style>
    </head>

    <body>
        <div class="sidebar">
            <h2>Menu</h2>
            <div class="sidebar-item active" onclick="goToSection('contact')">Contact Info</div>
            <div class="sidebar-item" onclick="goToSection('sport')">Select Sport</div>
        </div>

        <div class="content">
            <h1>SMC Sports Selection</h1>

            <div id="closed" class="section">
                <div class="closed-message">
                    <h2>Sports Selection Closed</h2>
                    <p id="openingMessage"></p>
                </div>
            </div>

            <div id="contact" class="section active">
                <h2>Step 1: Contact Information</h2>
                <div id="message" class="message"></div>
                
                <label>Email Address</label>
                <input type="text" id="emailInput" placeholder="your.email@stmarks.nsw.edu.au">
                
                <label>Full Name</label>
                <input type="text" id="nameInput" placeholder="John Smith">
                
                <label>Phone Number</label>
                <input type="text" id="phoneInput" placeholder="0412345678">
                
                <label>Year Level</label>
                <select id="yearInput">
                    <option value="">Select Year</option>
                    <option value="7">Year 7</option>
                    <option value="8">Year 8</option>
                    <option value="9">Year 9</option>
                    <option value="10">Year 10</option>
                </select>
                
                <button class="btn-primary" onclick="submitForm()">Next</button>
            </div>

            <div id="sport" class="section">
                <h2>Step 2: Select Your Sport</h2>
                <p id="welcomeMessage"></p>
                
                <div id="sportsList"></div>
                
                <button class="btn-secondary" onclick="refreshSports()">Refresh</button>
                <button class="btn-secondary" onclick="goToSection('contact')">Back</button>
                <div id="sportsMessage" class="message"></div>
            </div>

            <div id="nosports" class="section">
                <h2>No Sports Available</h2>
                <p id="welcomeMessage2"></p>
                <p>All sports are currently full. Your information has been saved and you will be contacted when spaces become available.</p>
                
                <button class="btn-success" onclick="saveWaitlist()">Save Information</button>
                <button class="btn-secondary" onclick="goToSection('contact')">Back</button>
            </div>

            <div id="success" class="section">
                <h2>Success!</h2>
                <p id="successMessage"></p>
                <button class="btn-primary" onclick="submitAnother()">Register Another Student</button>
            </div>
        </div>

        <script>
            let currentStudentId = null;
            let sports = [];

            function goToSection(sectionId) {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');
                
                const items = document.querySelectorAll('.sidebar-item');
                if (sectionId === 'contact') items[0].classList.add('active');
                if (sectionId === 'sport') items[1].classList.add('active');
                
                // Stop live updates if on success page
                if (sectionId === 'success') {
                    currentStudentId = null;
                }
            }

            function checkSystemStatus() {
                fetch('http://localhost:5000/get-system-status')
                    .then(response => response.json())
                    .then(data => {
                        if (!data.is_open) {
                            goToSection('closed');
                            const openDateTime = new Date(data.open_datetime);
                            const now = new Date();
                            if (openDateTime > now) {
                                document.getElementById('openingMessage').textContent = `Will open at ${openDateTime.toLocaleString()}`;
                            } else {
                                document.getElementById('openingMessage').textContent = 'Currently closed.';
                            }
                        }
                    })
                    .catch(error => console.error('Error checking status:', error));
            }

            function submitForm() {
                const email = document.getElementById('emailInput').value.trim();
                const name = document.getElementById('nameInput').value.trim();
                const phone = document.getElementById('phoneInput').value.trim();
                const year = document.getElementById('yearInput').value;
                const messageDiv = document.getElementById('message');

                if (!email || !name || !phone || !year) {
                    showMessage(messageDiv, 'Please fill in all fields', 'error');
                    return;
                }

                fetch('http://localhost:5000/submit-form', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email, name, phone, year })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentStudentId = data.student_id;
                        loadSports();
                    } else {
                        showMessage(messageDiv, data.message || 'Error submitting form', 'error');
                    }
                })
                .catch(e => {
                    console.error('Error:', e);
                    showMessage(messageDiv, 'Error connecting to server', 'error');
                });
            }

            function loadSports() {
                fetch('http://localhost:5000/get-sports')
                    .then(r => r.json())
                    .then(data => {
                        if (data.status === 'error') {
                            console.error('Error loading sports:', data.message);
                            return;
                        }
                        sports = data.sports || [];
                        const available = sports.filter(s => s.current_count < s.capacity);
                        
                        if (available.length === 0) {
                            goToSection('nosports');
                            document.getElementById('welcomeMessage2').textContent = 'Welcome!';
                        } else {
                            document.getElementById('welcomeMessage').textContent = 'Welcome! Select your sport:';
                            displaySports();
                            goToSection('sport');
                        }
                    })
                    .catch(e => {
                        console.error('Error:', e);
                        const msg = document.getElementById('sportsMessage');
                        showMessage(msg, 'Error loading sports', 'error');
                    });
            }

            function displaySports() {
                const list = document.getElementById('sportsList');
                list.innerHTML = '';
                
                sports.forEach(sport => {
                    const isFull = sport.current_count >= sport.capacity;
                    const card = document.createElement('div');
                    card.className = 'sport-card';
                    
                    let html = `<div class="sport-name">${sport.name}</div>`;
                    if (sport.description) {
                        html += `<div class="sport-description">${sport.description}</div>`;
                    }
                    
                    if (isFull) {
                        html += `<div class="sport-availability sport-full">FULL (${sport.current_count}/${sport.capacity})</div>`;
                    } else {
                        html += `<div class="sport-availability">Available: ${sport.capacity - sport.current_count} spots (${sport.current_count}/${sport.capacity})</div>`;
                        html += `<button class="btn-success" style="margin-top: 10px;" onclick="submitSport(${sport.id})">Select</button>`;
                    }
                    
                    card.innerHTML = html;
                    list.appendChild(card);
                });
            }

            function submitSport(sportId) {
                if (!currentStudentId) {
                    showMessage(document.getElementById('sportsMessage'), 'Student ID not found', 'error');
                    return;
                }

                fetch('http://localhost:5000/submit-sport', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ student_id: currentStudentId, sport_id: sportId })
                })
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        const sport = sports.find(s => s.id == sportId);
                        document.getElementById('successMessage').textContent = `You have been registered for ${sport.name}!`;
                        goToSection('success');
                    } else {
                        const msg = document.getElementById('sportsMessage');
                        showMessage(msg, data.message || 'Error registering', 'error');
                        loadSports();
                    }
                })
                .catch(e => {
                    console.error('Error:', e);
                    const msg = document.getElementById('sportsMessage');
                    showMessage(msg, 'Error connecting to server', 'error');
                });
            }

            function refreshSports() {
                loadSports();
                const msg = document.getElementById('sportsMessage');
                showMessage(msg, 'Refreshed!', 'success');
                setTimeout(() => msg.className = 'message', 2000);
            }

            function saveWaitlist() {
                if (!currentStudentId) {
                    console.error('Student ID not found');
                    return;
                }

                fetch(`http://localhost:5000/add-to-waitlist/${currentStudentId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                })
                .then(r => r.json())
                .then(data => {
                    document.getElementById('successMessage').textContent = 'Your information has been saved. We will contact you when spaces become available.';
                    goToSection('success');
                })
                .catch(e => {
                    console.error('Error:', e);
                    const msg = document.getElementById('message');
                    showMessage(msg, 'Error saving information', 'error');
                });
            }

            function submitAnother() {
                document.getElementById('emailInput').value = '';
                document.getElementById('nameInput').value = '';
                document.getElementById('phoneInput').value = '';
                document.getElementById('yearInput').value = '';
                currentStudentId = null;
                goToSection('contact');
            }

            function showMessage(element, text, type) {
                element.textContent = text;
                element.className = `message show ${type}`;
                setTimeout(() => {
                    element.className = 'message';
                }, 4000);
            }

            // Live update polling - only if student has registered but not finished
            function liveUpdate() {
                if (currentStudentId) {
                    loadSports();
                }
            }

            checkSystemStatus();
            setInterval(checkSystemStatus, 2000);
            setInterval(liveUpdate, 2000);
        </script>

        <div class="footer">
            Developed by Marcus Papasavvas
        </div>
    </body>
</html>